<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Believe - NGO Dashboard</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
  
  .dash { max-width:1100px; margin:20px auto; padding:0 18px; }
  .card { background:#fff; padding:14px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); margin-bottom:12px; }
  .ngo-projects { margin-left:20px; font-size:14px; }
  .ngo-projects li { margin-bottom:4px; }



      
    .dash { max-width:1100px; margin:20px auto; padding:0 18px; }
    .card { background:#fff; padding:14px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); margin-bottom:12px; }

    .ngo-table { width:100%; border-collapse:collapse; font-size:14px; margin-top:8px; }
    .ngo-table th, .ngo-table td {
      border:1px solid #eee;
      padding:6px 8px;
      text-align:left;
    }
    .ngo-table th { background:#f7f9fc; }

    .ngo-projects { list-style:disc; margin-left:20px; margin-top:6px; }
    .ngo-projects li { margin-bottom:4px; }

   /* Header layout */
.head {
    display: flex;
    justify-content: space-between; /* brand left, logout right */
    align-items: center;
    padding: 12px 25px;
    background: #ffffff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Brand name */
.brand {
    font-size: 26px;
    font-weight: bold;
    color: #1656a2;
    text-decoration: none;
}

/* Logout button */
.logout-btn {
    background: #1656a2;
    color: white;
    border: none;
    padding: 8px 16px;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.2s;
}

.logout-btn:hover {
    background: #0e3e76;
}

/* Status badge (same idea as donor side) */
.status-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
}

/* Colors for each status */
.status-processing {
    background: #fff7e6;
    color: #b26b00;
}

.status-received {
    background: #e6f4ff;
    color: #0b63b6;
}

.status-implementing {
    background: #f3e6ff;
    color: #6b2fb6;
}

.status-completed {
    background: #e6f7e9;
    color: #1f7a34;
}

.status-reported {
    background: #e6fffb;
    color: #00796b;
}

.status-flagged {
    background: #ffe6e6;
    color: #b21f1f;
}

/* Small action button inside the table */
.status-action-btn {
    padding: 4px 10px;
    font-size: 12px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    background: #1656a2;
    color: #fff;
}

.status-action-btn:hover {
    background: #0e3e76;
}


  

  </style>
</head>
<body>
  <header class="head">
  <a href="index.html" class="brand">Believe</a>

  <button id="logoutBtn" class="logout-btn">
      Logout
  </button>
</header>

    <main class="dash">
    <h2>NGO Dashboard</h2>

    <!-- NGO summary + compliance -->
    <div class="card">
      <h3 id="ngo-name">NGO Name (demo)</h3>
      <p>Compliance status: <strong id="ngo-status">Unverified</strong></p>
      <p style="font-size:14px;color:#555;">
        This is a frontend demo. Status is based on whether this NGO has any verified projects in <code>projects.xml</code>.
      </p>
    </div>

    <!-- Incoming donations for this NGO -->
    <div class="card">
  <h3>Incoming Donations (demo)</h3>
  <table class="ngo-table">
    <thead>
      <tr>
        <th>Project</th>
        <th>Date</th>
        <th>Amount (BDT)</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="ngo-donations-body">
      <tr><td colspan="5">Loading...</td></tr>
    </tbody>
  </table>
</div>


    <!-- Active projects for this NGO -->
    <div class="card">
  <h3>Active Projects</h3>
  <ul id="ngo-projects-list" class="ngo-projects">
    <li>Loading...</li>
  </ul>
  <p style="font-size:13px;color:#777;margin-top:8px;">
    Projects are loaded from <code>projects.xml</code> based on this NGO’s name.
  </p>
</div>

<!-- NGO Project Submission Section -->
<div class="card" id="projectSubmissionCard" style="margin-top:20px;">
  <h3>Submit New Project</h3>

  <form id="projectSubmissionForm">
    <label>Project Title:</label><br>
    <input type="text" id="projTitle" required style="width:100%; padding:7px; margin-bottom:10px;"><br>

    <label>Short Description:</label><br>
    <textarea id="projDesc" required style="width:100%; padding:7px; margin-bottom:10px;"></textarea><br>

    <label>Goal Amount (BDT):</label><br>
    <input type="number" id="projGoal" required min="1" style="width:100%; padding:7px; margin-bottom:10px;"><br>

    <button type="submit" class="btn" style="padding:8px 18px;">Submit Project</button>
  </form>

  <p id="projSubmitMsg" style="color:green; font-size:14px; margin-top:10px; display:none;">
    Project submitted! Waiting for Admin approval.
  </p>
</div>


  </main>


    <script>
  // 1) Get logged-in NGO from demoSession
  const session = JSON.parse(localStorage.getItem('demoSession') || 'null');
  const ngoNameEl = document.getElementById('ngo-name');
  const ngoStatusEl = document.getElementById('ngo-status');
  const projectsList = document.getElementById('ngo-projects-list');
  const donationsBody = document.getElementById('ngo-donations-body');

  const ngoName = (session && session.role === 'ngo') ? session.name : null;

  if (ngoName) {
    ngoNameEl.textContent = ngoName;
  } else {
    ngoNameEl.textContent = 'NGO (not logged in)';
    projectsList.innerHTML = '<li>Please login as an NGO account to see your projects.</li>';
    donationsBody.innerHTML = '<tr><td colspan="3">Please login as an NGO account to see incoming donations.</td></tr>';
  }

  if (!ngoName) {
    ngoStatusEl.textContent = 'Unverified';
  } else {
    loadNgoDashboard();
  }

  async function loadNgoDashboard() {
    // Map: project title -> NGO name (from projects.xml)
    const projectOwnerByTitle = {};
    let hasVerifiedProject = false;

    try {
      const resp = await fetch('projects.xml');
      if (!resp.ok) throw new Error('Could not load projects.xml');
      const text = await resp.text();
      const xml = new DOMParser().parseFromString(text, 'application/xml');
      const projects = xml.querySelectorAll('project');

      projectsList.innerHTML = '';

      projects.forEach(p => {
        const title = p.querySelector('title')?.textContent || '';
        const ngo = p.querySelector('ngo')?.textContent || '';
        const verified = p.querySelector('verified')?.textContent === 'true';

        if (title) {
          projectOwnerByTitle[title] = ngo;
        }

        // Active projects for this NGO
        if (ngo.toLowerCase().startsWith(ngoName.toLowerCase())) {
          const li = document.createElement('li');
          li.textContent = title + (verified ? ' (Verified project)' : '');
          projectsList.appendChild(li);
          if (verified) hasVerifiedProject = true;
        }
      });

      if (!projectsList.hasChildNodes()) {
        projectsList.innerHTML = '<li>No projects found for this NGO in projects.xml (demo).</li>';
      }

      ngoStatusEl.textContent = hasVerifiedProject
        ? 'Verified (has verified projects)'
        : 'Unverified';

    } catch (err) {
      console.error(err);
      projectsList.innerHTML = '<li>Could not load projects.xml.</li>';
      ngoStatusEl.textContent = 'Unverified';
    }

    // 2) Load incoming donations for this NGO
    // 2) Load incoming donations for this NGO
const allDonations = JSON.parse(localStorage.getItem('donorHistory') || '[]');
donationsBody.innerHTML = '';

const STATUS_FLOW = ['processing', 'received', 'implementing', 'completed', 'reported'];

const incomingForThisNgo = allDonations
  .map((d, idx) => ({ ...d, _idx: idx }))  // keep index in original array
  .filter(d => {
    const owner = projectOwnerByTitle[d.project];
    if (!owner) return false;
    return owner.toLowerCase().startsWith(ngoName.toLowerCase());
  });

if (incomingForThisNgo.length === 0) {
  donationsBody.innerHTML = '<tr><td colspan="5">No donations for this NGO yet (demo).</td></tr>';
} else {
  incomingForThisNgo.forEach(d => {
    const tr = document.createElement('tr');

    const tdProject = document.createElement('td');
    const tdDate = document.createElement('td');
    const tdAmount = document.createElement('td');
    const tdStatus = document.createElement('td');
    const tdAction = document.createElement('td');

    tdProject.textContent = d.project || '';
    tdDate.textContent = d.date || '';
    tdAmount.textContent = '৳' + Number(d.amount).toLocaleString();

    // Status badge
    const statusSpan = document.createElement('span');
    const statusValue = (d.status || 'processing').toLowerCase();
    statusSpan.classList.add('status-badge');

    switch (statusValue) {
      case 'received':
        statusSpan.classList.add('status-received');
        statusSpan.textContent = 'Received';
        break;
      case 'implementing':
        statusSpan.classList.add('status-implementing');
        statusSpan.textContent = 'In Implementation';
        break;
      case 'completed':
        statusSpan.classList.add('status-completed');
        statusSpan.textContent = 'Completed';
        break;
      case 'reported':
        statusSpan.classList.add('status-reported');
        statusSpan.textContent = 'Reported';
        break;
      case 'flagged':
        statusSpan.classList.add('status-flagged');
        statusSpan.textContent = 'Flagged / On Hold';
        break;
      default:
        statusSpan.classList.add('status-processing');
        statusSpan.textContent = 'Processing';
    }

    tdStatus.appendChild(statusSpan);

    // Action button: advance to next status in STATUS_FLOW
    const actionBtn = document.createElement('button');
    actionBtn.textContent = 'Advance';
    actionBtn.className = 'status-action-btn';
    actionBtn.onclick = () => {
      const all = JSON.parse(localStorage.getItem('donorHistory') || '[]');
      const rec = all[d._idx];
      if (!rec) return;

      const current = (rec.status || 'processing').toLowerCase();
      const pos = STATUS_FLOW.indexOf(current);
      const nextStatus = STATUS_FLOW[Math.min(STATUS_FLOW.length - 1, pos + 1)];

      rec.status = nextStatus;
      all[d._idx] = rec;
      localStorage.setItem('donorHistory', JSON.stringify(all));

      // Re-render dashboard after update
      loadNgoDashboard();
    };
    tdAction.appendChild(actionBtn);

    tr.appendChild(tdProject);
    tr.appendChild(tdDate);
    tr.appendChild(tdAmount);
    tr.appendChild(tdStatus);
    tr.appendChild(tdAction);

    donationsBody.appendChild(tr);
  });
}

  }
  document.getElementById("logoutBtn").onclick = () => {
    localStorage.removeItem("demoSession");
    window.location.href = "login.html";
};



// Show or hide project submission based on approval status
const currentSession = JSON.parse(localStorage.getItem('demoSession') || '{}');
if (currentSession.status !== 'approved') {
  document.getElementById('projectSubmissionCard').style.display = 'none';
}

// Handle project submission
document.getElementById('projectSubmissionForm')?.addEventListener('submit', (e) => {
  e.preventDefault();

  const title = document.getElementById('projTitle').value.trim();
  const desc  = document.getElementById('projDesc').value.trim();
  const goal  = Number(document.getElementById('projGoal').value);

  let requests = JSON.parse(localStorage.getItem('projectRequests') || '[]');

  requests.push({
    ngoName: currentSession.name,
    title: title,
    desc: desc,
    goal: goal,
    status: "pending",
    date: new Date().toISOString().slice(0, 10)
  });

  localStorage.setItem('projectRequests', JSON.stringify(requests));

  document.getElementById('projSubmitMsg').style.display = 'block';
  e.target.reset();
});


</script>


</body>
</html>
